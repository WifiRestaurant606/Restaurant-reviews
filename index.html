<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Restaurant & Cafe - مراجعات العملاء</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the premium look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background */
        }
        .star-svg {
            cursor: pointer;
            transition: color 0.2s;
        }
        /* Custom scrollbar for a darker theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #3f3f46;
            /* Gray-700 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #1a1a1a;
        }
    </style>
</head>
<body class="min-h-screen text-white flex flex-col items-center p-4 sm:p-8">

    <script type="module">
        // Added 'getDocs' for the submission limit check
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, Timestamp, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use the globally available variables for Firebase setup
        const appId = typeof __app_id !== 'undefined' ?
        __app_id : 'default-app-id';
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDCuuSOG1rpSq4WclvR2anqTpn4LjsY_0g",
  authDomain: "wifi-reviews.firebaseapp.com",
  projectId: "wifi-reviews",
  storageBucket: "wifi-reviews.firebasestorage.app",
  messagingSenderId: "1040632139971",
  appId: "1:1040632139971:web:8a6450cd422d176ca51276",
  measurementId: "G-0Y032VRX03"
};
        const reviewForm = document.getElementById('reviewForm');
        const ratingDisplay = document.getElementById('ratingDisplay');
        const messageBox = document.getElementById('messageBox');
        const recentReviewsListContainer = document.getElementById('recentReviewsListContainer');
        let currentRatings = { food: 0, service: 0 }; // Local state for the form

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('Debug');
            
            window.db = db;
            window.auth = auth;
            window.Timestamp = Timestamp;
            // Public data collection for global reviews
            window.reviewsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'restaurant_reviews');
            // Authentication (Silent Sign-in)
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
           
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // Sign in anonymously for public access
                     
                            await signInAnonymously(auth);
                        }
                        console.log("Authentication successful.");
                    } catch (error) {
                    
                        console.error("Authentication failed:", error);
                    }
                }
                // Once authenticated, start listening for data
                if (auth.currentUser) {
                  
                    window.userId = auth.currentUser.uid;
                    startRealtimeListener();
                } else {
                    // Fallback for extreme cases where auth.currentUser is not set after sign-in attempt
                    window.userId = crypto.randomUUID();
                    startRealtimeListener();
                }
            });
        } else {
            console.error("Firebase is not configured. Review system will not function.");
            recentReviewsListContainer.innerHTML = '<p class="text-red-400 text-center p-6">فشل تهيئة قاعدة البيانات. لا يمكن عرض المراجعات.</p>';
        }

        // --- Core Logic Functions ---

        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `p-3 mb-4 rounded-lg text-center font-bold text-sm ${type === 'success' ? 'bg-orange-500 text-white' : 'bg-red-600 text-white'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        function renderStars(containerId, ratingType) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous stars
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                star.setAttribute("viewBox", "0 0 24 24");
                star.setAttribute("fill", i <= currentRatings[ratingType] ? "#F97316" : "#4b5563");
                star.setAttribute("stroke", i <= currentRatings[ratingType] ? "#F97316" : "#4b5563");
                star.setAttribute("stroke-width", "2");
                star.setAttribute("stroke-linecap", "round");
                star.setAttribute("stroke-linejoin", "round");
                star.classList.add('w-8', 'h-8', 'star-svg', 'mx-1');
                star.dataset.value = i;
                star.dataset.type = ratingType;

                star.innerHTML = '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>';
                star.addEventListener('click', () => {
                    currentRatings[ratingType] = i;
                    renderStars(containerId, ratingType); // Re-render to update colors
                });
                container.appendChild(star);
            }
        }

        function calculateAverages(reviews) {
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            let dailyRatings = [];
            let weeklyRatings = [];
            let monthlyRatings = [];
            
            let totalReviewsCount = 0;
            let overallTotalStars = 0;
            reviews.forEach(review => {
                // Ensure timestamp exists before using it
                if (!review.timestamp || !review.timestamp.toDate) return;
                
                const timestamp = review.timestamp.toDate();
                
     
                // Calculate average of the two categories for this review
                const overallReviewRating = (review.foodRating + review.serviceRating) / 2;
                overallTotalStars += overallReviewRating;
                totalReviewsCount++; // Count all reviews for overall average

                
                // Time filtering
                if (timestamp >= oneDayAgo) dailyRatings.push(overallReviewRating);
                if (timestamp >= oneWeekAgo) weeklyRatings.push(overallReviewRating);
                if (timestamp >= oneMonthAgo) monthlyRatings.push(overallReviewRating);
            });
            // Calculate overall average for display
            const formatAvg = (arr) => arr.length > 0 ?
            (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1) : '0.0';
            
            const totalAverage = totalReviewsCount > 0 ?
            (overallTotalStars / totalReviewsCount).toFixed(1) : '0.0';

            return {
                totalAverage,
                daily: formatAvg(dailyRatings),
                weekly: formatAvg(weeklyRatings),
                monthly: formatAvg(monthlyRatings),
                totalCount: totalReviewsCount
          
            };
        }
        
        function getStarHTML(rating, size = 'w-5 h-5') {
            const fullStars = Math.floor(rating);
            const fractional = rating - fullStars;
            let stars = '';
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                stars += `<svg viewBox="0 0 24 24" fill="#F97316" stroke="#F97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size}"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
            }

            // Half star (if fractional is >= 0.25)
            if (fractional >= 0.25 && fullStars < 5) {
                // Simplified half-star using a gradient mask for visual effect.
                const uniqueId = `grad-${Math.random().toString(36).substring(2, 9)}`;
                stars += `<svg viewBox="0 0 24 24" class="${size} relative">
                            <defs>
                                <linearGradient id="${uniqueId}">
                          
                                    <stop offset="${(fractional * 100)}%" stop-color="#F97316" />
                                    <stop offset="${(fractional * 100)}%" stop-color="#4b5563" />
                                </linearGradient>
            
                            </defs>
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="url(#${uniqueId})" stroke="#4b5563" stroke-width="1.5"></polygon>
                        </svg>`;
            }

            // Empty stars
            const starsRendered = fullStars + (fractional >= 0.25 ? 1 : 0);
            const remainingStars = 5 - starsRendered;
             for (let i = 0; i < remainingStars; i++) {
                stars += `<svg viewBox="0 0 24 24" fill="none" stroke="#4b5563" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size}"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
            }


            return `<div class="flex ltr:flex-row rtl:flex-row-reverse space-x-0.5">${stars}</div>`;
        }


        function updateRatingDisplay(reviews) {
            const averages = calculateAverages(reviews);
            const totalAverage = parseFloat(averages.totalAverage);

            ratingDisplay.innerHTML = `
                <div class="p-6 bg-gray-800 rounded-2xl shadow-xl border-4 border-orange-500 w-full">
                    <div class="text-center mb-6">
                        <p class="text-3xl font-bold text-white mb-2">متوسط التقييم العام</p>
                   
                        <div class="flex items-center justify-center space-x-2">
                            <span class="text-6xl font-extrabold text-orange-500">${averages.totalAverage}</span>
                            <span class="text-3xl text-gray-400">/ 5</span>
                        </div>
     
                        ${getStarHTML(totalAverage, 'w-10 h-10')}
                        <p class="text-sm text-gray-400 mt-2">${averages.totalCount} مراجعة إجمالية</p>
                    </div>

                    <div class="grid grid-cols-3 gap-4 text-center border-t border-gray-700 pt-4">
   
                        <div class="p-2 bg-gray-900 rounded-xl">
                            <p class="text-lg font-semibold text-orange-500">${averages.daily}</p>
                            <p class="text-xs text-gray-400">يومي</p>
               
                        </div>
                        <div class="p-2 bg-gray-900 rounded-xl">
                            <p class="text-lg font-semibold text-orange-500">${averages.weekly}</p>
                            <p class="text-xs text-gray-400">أسبوعي</p>
   
                        </div>
                        <div class="p-2 bg-gray-900 rounded-xl">
                            <p class="text-lg font-semibold text-orange-500">${averages.monthly}</p>
                     
                            <p class="text-xs text-gray-400">شهري</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRecentReviews(reviews) {
            if (!recentReviewsListContainer) return;
            if (reviews.length === 0) {
                recentReviewsListContainer.innerHTML = `
                    <div class="p-6 bg-gray-800 rounded-2xl shadow-xl border border-gray-700">
                        <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-3">أحدث المراجعات</h2>
                    
                        <p class="text-gray-400 text-center text-xl p-4">لا توجد مراجعات بعد.
                        كن أول من يراجعنا!</p>
                    </div>
                `;
            return;
            }

            let html = '';
            reviews.forEach(review => {
                const foodStars = getStarHTML(review.foodRating, 'w-4 h-4');
                const serviceStars = getStarHTML(review.serviceRating, 'w-4 h-4');
                const displayComment = review.comments || 'لا توجد تعليقات إضافية.';
                // Ensure timestamp exists before using it
          
                const date = review.timestamp && review.timestamp.toDate ? review.timestamp.toDate().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' }) : 'تاريخ غير معروف';
                
                // Displaying the reviewer's provided name
                const reviewerName = review.customerName || 'مستخدم مجهول';


                
                html += `
                    <div class="bg-gray-700 p-5 rounded-xl border border-gray-600 shadow-md transform hover:scale-[1.01] transition duration-200">
                        <div class="flex justify-between items-center mb-3 border-b border-gray-600 pb-2">
                            <p class="text-md font-semibold text-orange-400">${reviewerName}</p>
      
                            <p class="text-sm text-gray-400">${date}</p>
                        </div>
                        
                        <div class="space-y-3">
   
                            <div class="flex justify-between items-center">
                                <span class="text-md font-semibold text-gray-200">المأكولات:</span>
                                ${foodStars}
     
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-md font-semibold text-gray-200">الخدمة:</span>
           
                                ${serviceStars}
                            </div>
                        </div>

                        <div class="mt-4 pt-3 
                        border-t border-gray-600">
                            <p class="text-md font-semibold text-orange-400 mb-1">التعليق:</p>
                            <p class="text-gray-300 italic text-sm leading-relaxed">${displayComment}</p>
                        </div>
           
                    </div>
                `;
            });

            // Add wrapping structure
            recentReviewsListContainer.innerHTML = `
                <div class="p-6 bg-gray-800 rounded-2xl shadow-xl border border-gray-700">
                    <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-3">أحدث المراجعات (10)</h2>
                    <div class="space-y-4 max-h-[600px] overflow-y-auto p-2">${html}</div>
       
                </div>
            `;
        }

        function startRealtimeListener() {
            if (!window.reviewsCollection) return;
            // Query to get the latest 10 reviews
            // NOTE: Firestore requires an index on 'timestamp' for this query.
            const reviewsQuery = query(window.reviewsCollection, orderBy('timestamp', 'desc'), limit(10));

            // Listen to all documents in the 'restaurant_reviews' collection
            onSnapshot(reviewsQuery, (snapshot) => {
                const reviews = [];
                snapshot.forEach(doc => {
                    reviews.push(doc.data());
             
                });
                console.log("Realtime update received. Total reviews fetched:", reviews.length);
                updateRatingDisplay(reviews);
                renderRecentReviews(reviews);
            }, (error) => {
                console.error("Error listening to reviews:", error);
        
                showMessage("فشل في تحميل المراجعات في الوقت الفعلي. تحقق من اتصالك.", 'error');
            });
        }
        
        /**
         * Utility function to get the start of the current day (midnight today) 
         * as a JavaScript Date object, which is then converted to a Firestore Timestamp.
         */
        function getStartOfToday() {
            const now = new Date();
            // Create a new Date object set to midnight (00:00:00) today
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
            return startOfToday;
        }


        reviewForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const foodRating = currentRatings.food;
            const serviceRating = currentRatings.service;
            const comments = document.getElementById('comments').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
  
            const customerPhone = document.getElementById('customerPhone').value.trim();


            // --- Step 1: Mandatory Field Validation ---
            if (!customerName || !customerPhone || foodRating === 0 || serviceRating === 0) {
                showMessage('الرجاء تعبئة الاسم ورقم الهاتف وتقييم كل من المأكولات والخدمة.', 'error');
                return;
  
            }

            const submitButton = document.getElementById('submitBtn');
            submitButton.disabled = true;
            submitButton.textContent = '...جاري التحقق والإرسال';

            try {
                if (!window.db ||
                !window.reviewsCollection || !window.userId) {
                    throw new Error("Firebase or Collection not initialized, or user not authenticated.");
                }

                // --- Step 2: Daily Submission Limit Check ---
                
                const startOfTodayDate = getStartOfToday();
                const startOfTodayTimestamp = window.Timestamp.fromDate(startOfTodayDate);

                const limitQuery = query(
                    window.reviewsCollection,
                    where('userId', '==', window.userId), // Check only the current user's submissions
                    where('timestamp', '>=', startOfTodayTimestamp) // Check submissions made since midnight today
               
                );
                
                const snapshot = await getDocs(limitQuery);

                if (snapshot.size >= 2) {
                    showMessage('عفواً، لا يمكنك إرسال أكثر من مراجعتين في اليوم الواحد. حاول مرة أخرى غداً.', 'error');
                    submitButton.disabled = false;
                    submitButton.textContent = 'إرسال المراجعة';
                    return;
                }

                // --- Step 3: Add Document to Firestore ---
                await addDoc(window.reviewsCollection, {
                    foodRating: foodRating,
                    serviceRating: serviceRating,
        
                    comments: comments,
                    customerName: customerName, // Added mandatory field
                    customerPhone: customerPhone, // Added mandatory field
                    timestamp: window.Timestamp.now(),
                
                    userId: window.userId,
                });
                showMessage('شكراً لك على تقييمك! تم إرسال مراجعتك بنجاح.', 'success'); // Added complete success message
            } catch (error) {
                console.error("Error submitting review:", error);
                showMessage(`حدث خطأ أثناء إرسال المراجعة: ${error.message}`, 'error');
            } finally {
                // Re-enable the button regardless of success or failure
                submitButton.disabled = false;
                submitButton.textContent = 'إرسال المراجعة';
            }
        });
        // You should also call renderStars on page load for the initial state, assuming the HTML structure has elements with IDs 'foodRatingContainer' and 'serviceRatingContainer'
        // renderStars('foodRatingContainer', 'food');
        // renderStars('serviceRatingContainer', 'service');
    </script>
</body>
</html>
